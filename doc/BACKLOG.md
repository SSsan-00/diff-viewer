# 改善案バックログ

目的: 仕様・ドキュメント更新のための待機所。実装はここでは行わない。

## Next
優先度理由: 依存が少なく、体験改善やバグ修正効果が大きいもの。

| 項目 | 種別 | doc/SPEC.md 反映先候補 | 受け入れ条件のヒント | 依存関係 |
| --- | --- | --- | --- | --- |
| 折り返しON時に対応行がズレる | bug | 5.2 行レベル差分 / 4.2 操作 | 折り返しONでも対応行（equal/replace）が左右で同じYに揃う。Alt+Z 切替後のレイアウト確定→再計算で視覚ズレが最小化される。 | レイアウト確定後再計算の共通化が望ましい |

## Should
優先度理由: 体験改善・機能追加で有益だが、順番は柔軟。

| 項目 | 種別 | doc/SPEC.md 反映先候補 | 受け入れ条件のヒント | 依存関係 |
| --- | --- | --- | --- | --- |
| 空白行非表示トグルの配置変更 | request | 4.2 操作 / 5.2 行レベル差分 | 画面ヘッダで「差分なし折りたたみ」の左に配置。切替後も対応行/アンカーがズレない（レイアウト確定後に再計算）。 | レイアウト確定後再計算の共通化が望ましい |
| ペイン間ドラッグで幅調整 | request | 4.1 レイアウト | divider ドラッグで左右幅が変わり、drag end で layout → rAF → 再計算。対応行/アンカーがズレない。 | レイアウト確定後再計算の共通化が望ましい |

## Later
優先度理由: 高コスト/要検討/仕様が固まっていない項目。

| 項目 | 種別 | doc/SPEC.md 反映先候補 | 受け入れ条件のヒント | 依存関係 |
| --- | --- | --- | --- | --- |
| ペイン別の折り返しトグル | request | 4.2 操作 | 左右ペインで独立して折り返しON/OFFでき、切替後はレイアウト確定後に再計算してズレない。 | Alt+Z の全体切替との整合が必要 |

## Done
| 項目 | 種別 | doc/SPEC.md 反映先候補 | 受け入れ条件のヒント |
| --- | --- | --- | --- |
| Ctrl+F でペイン内検索ができない | bug | 4.2 操作 | Ctrl/Cmd+F でフォーカス中の Monaco 検索UIが開く。フォーカス不明時は最後にフォーカスしたペインを使い、ブラウザ検索は抑止される（左右クリック後に検証）。 |
| Ctrl+F の検索UI表示で対応行がズレる | bug | 7. 再計算仕様 | Find Widget の開閉でレイアウトが変わっても対応行の縦位置が崩れない。layout/content-size 変化で再計算が走ることを確認する。 |
| Ctrl+G 行ジャンプをファイル単位で行う（複数ファイル対応） | request | UI仕様 / 4.2 操作 / 10.3 複数ファイル読み込み | Ctrl+G の対象は「フォーカス中のファイル」。ファイル選択UIで切替でき、選択したファイルのローカル行番号でジャンプできる（通し番号の手計算不要）。長いファイル名は省略せず表示し、スクロール連動OFF時は片側のみ移動する。 |
| Ctrl/Cmd+J・Ctrl/Cmd+K でペインフォーカス移動 + 行ジャンプUIのファイル選択移動 | request | UI仕様 / 4.2 操作 | 通常時は Ctrl/Cmd+J で左ペイン、Ctrl/Cmd+K で右ペインに移動元カーソル行と同じ縦位置の行へフォーカス移動する（取得できない場合は表示最上行へ）。行ジャンプUI表示中は Ctrl/Cmd+J/K でファイル選択を左右移動できる。 |
| シンタックスハイライト機能の実装 | request | 10.1 UI仕様 / 4.2 操作 | ヘッダの「ハイライト」トグルで ON/OFF 切替。OFF は `plaintext`、ON は拡張子推定で言語適用（混在時は優先順位で1言語）。ON/OFF で色付けが変化し、console に worker エラーが出ないことを確認。 |
| 配布物に `http` / `github` 系文字列が残る | build | 3.2 配布物に「特定文字列」を残さない / 13.3 リリース手順 | `dist/index.html` / `dist/index.min.html` に禁止文字列が含まれない。monaco の該当文字列をパッチで削除し、コメント除去を有効化した上で `build:single` → `verify:dist` が Green。 |
| 左右ペイン別クリア | request | 4.2 操作 | 左のみ/右のみのクリアができ、他方は保持される。 |
| クリア時に全アンカーを消す（両ペイン） | request | 4.2 操作 / 8. アンカー行仕様 | 左/右どちらのクリアでも全アンカー（manual/auto/pending/selected/decoration）が消える。差分再計算が破綻しない（左右クリアで確認）。 |
| クリア操作の Undo 対応（Ctrl/Cmd+Z） | request | 4.2 操作 | クリア直後に Undo でテキストが復元される。アンカーは復元しない（消えたまま）ことを仕様化し、復元後は再計算される。 |
| 編集時の自動再計算（デバウンス） | request | 7. 再計算仕様 | 編集中はデバウンス（目安: 200ms）で差分が自動更新される。実行中の重複計算は抑制され、`差分再計算` ボタンは即時再計算する。 |
| 拡張子 .inc を PHP として扱う | request | 10.1 UI仕様 / 10.3 複数ファイル読み込み | `foo.inc` が `php` として推定され、`foo.inc + bar.html` の混在でも `php` が選ばれる。 |
| 対応行検出のブラッシュアップ（PHPタグの `{}` 対応） | request | 5.2 行レベル差分 | `{` ↔ `<? { ?>`、`}` ↔ `<? } ?>` が replace で揃い、`<? ?>` とインデント差が行内差分として見える。 |
| 対応行検出のブラッシュアップ（文字列内 CSS/JS/HTML の抽出） | request | 5.2 行レベル差分 | `createCss`/`createJs`/`createHtml` 例の本体行が replace で揃い、行内差分が出る（`body {` / `console.log` / `<div ...>` などを確認）。 |
| LocalStorageで状態保存・復元 | request | UI仕様 / 非機能要件 | リロード後に前回の内容・UI状態が復元される。 |
| ファイル構成を確認できる doc/STRUCTURE.md を新規作成 | docs | ドキュメント方針 | 主要ディレクトリと役割が一覧化される。 |
| アンカーが増えると表示領域が狭くなるため折りたたみUI | request | 4.2 操作 / アンカー行仕様 | アンカーパネルを折りたため、表示領域の確保ができる。 |
| 「ファイルを選択」UIを各ペイン左側に配置 | request | 4.1 レイアウト / 10.1 UI仕様 | 左右それぞれ独立して操作でき、ヘッダ/ツールバーの縦幅が増えない。 |
| 「ここにファイルをドロップ」UIを廃止し、ペイン全面ドロップにする | request | 4.1 レイアウト / 10.1 UI仕様 | ペイン内のどこにドロップしても読み込める。ドロップ可能状態の視覚フィードバックを定義する。 |
| 複数ファイル間の余白を見やすくする（論理行番号は維持） | request | 10.3 連結ルール / 行番号定義 | 表示上は十分な空白があり、表示行番号と元ファイルの論理行番号が混同されない。差分計算やアンカー指定の行番号がズレない。 |
| 複数ファイル読み込み時の行番号が不安定（2始まり/連番化など） | bug | 10.3 複数ファイル読み込み / 行番号 | 複数回の追加読み込みでも各ファイルが必ず 1..N で採番される。 |
| アンカー行番号表示を file-local にする | bug | 8. アンカー行仕様 / 10.3 行番号 | アンカー表示が「ファイル単位の行番号」を示し、全体連番にならない。 |
| ファイルごとに行番号やアンカーが視認しやすいスタイル | request | 8. アンカー行仕様 / UI仕様 | どのファイルの行か UI 上で分かる（色/バッジ/区切り等）。既存アンカー機能と衝突しない。 |
| ペイン間のファイル数差で対応行の表示がズレる | bug | 5.2 行レベル差分 / 10.3.4 ファイル境界の表示 | 左に2ファイル・右に1ファイルの読み込みでも、差分の行揃えがファイル境界の余白分だけズレない。viewZone 等の表示余白は対応行の縦位置に影響しない。 |
| 可読版 `dist/index.html` のレイアウト崩れ | build | 13.2 ビルド成果物の種類 / 12.1.2 配布物受け入れ条件 | `dist/index.html` と `dist/index.min.html` を `file://` 直開きで比較し、主要UIの配置・スタイルが一致する。`format-readable.mjs` を外し、レイアウト一致を優先する方針で解消。 |
| `自動` で EUC-JP が文字化けする | bug | 10.4 混在文字コードの読み込み / 12.1.1 受け入れ条件 | `auto` で EUC-JP バイト列を読み込んでも文字化けしない。置換文字が同点の場合は日本語文字数で判定する。 |
| ファイル読み込み時に `cannot access 'p8' before initialization` が出る | bug | 10.1 UI仕様 / 10.4 混在文字コード | ファイル読み込み時にコンソール/画面へ上記エラーが出ない。TDZ系エラーは詳細を伏せて通知する。 |
| アンカーパネルの折りたたみUIをトグルボタンにする | request | 4.2 操作 / 8. アンカー行仕様 | 折りたたみ状態がボタンの見た目/`aria-expanded` で明確に分かる。キーボード操作でも切替可能。 |
| アンカー折りたたみ時も高さを2件分確保してスクロール | request | 4.2 操作 / 8. アンカー行仕様 | 折りたたみ時もアンカー表示は残り、高さは固定（2件分）。overflow-y でスクロールできる（一覧に3件以上ある状態で確認）。 |
| アンカー解除時の丸マーカーが残る | bug | 8. アンカー行仕様 / 4.2 操作 | 解除時に再計算し、ペア解除で左右両方の丸マーカーが消える。片側選択は同じ行の再クリックで解除できる。 |
| Ctrl+F をフォーカス中のペイン検索にする | request | 4.2 操作 | 左/右エディタのどちらにフォーカスがあるかで検索対象が切り替わる。フォーカス不明時は最後にフォーカスしたペインを優先する。 |
| ダークテーマの視認性改善（アンカー一覧/ファイル名表示） | bug | UI仕様 / 4.2 操作 | ダークテーマ時にアンカー一覧の hover/selected が読める配色になり、ペイン内のファイル名表示が見える。テーマ切替で即時反映される（🌙切替後に確認）。 |
| 文字コード変更時に再解釈（再デコード）する | request | 10.4.2 文字コード選択の扱い | 文字コード変更で同じ元バイト列を再デコードし、再読み込みなしで表示が更新される。rawBytesが無い場合は再デコードしない。 |
| 対応行検出の追加ケース（PHP/C# 定数） | request | 5.2 行レベル差分 | `define('FOO','foo');` と `public readonly string FOO = 'foo';` が同じブロック/同一表示行に揃う。識別子/リテラルで誤マッチを抑止する。 |
| 対応行判定のブラッシュアップ（インデント差のコメント/キーワード） | bug | 5.2 行レベル差分 | コメント行/`break;`/`else`/`{` のインデント差が replace で揃い、先頭空白が行内差分として表示される。`}` `else` `{` の分割パターンでも else 行が replace で揃う。 |
| 対応行の精度改善（PHP/C# 比較強化） | request | 5.2 行レベル差分 | インデント差は replace で揃い、行内差分で空白差が見える。`AppendLine`/`$sql .=` と `StringBuilder sql = new()`/`$sql = ""` が replace で並ぶ。ブレース単独行 `}` も文脈付きで replace 揃え。関数宣言/代入は **同名** の場合のみ replace（`test` と `test2` / `foo` と `food` は対象外）。 |
| ☀️/🌙 トグルでダークテーマ | request | 4.2 操作 / UI仕様 | ヘッダーに ☀️/🌙 トグルがありクリックでテーマが切り替わる。主要UI（背景/文字/ボタン/差分色）が読める。起動時に前回状態を復元する。 |
| 読み込んだファイル名表示が全て大文字になる | bug | 10.1 UI仕様 / 10.3 複数ファイル読み込み | 表示を大文字化する CSS（`text-transform`）を解除し、`File.name` の大小文字がそのまま表示される。複数ファイルでも表示が保持される。 |
| 読み込み完了メッセージにファイル名を全件列挙する | request | 10.1 UI仕様 | 追加読み込み時も「現在のペイン内に読み込まれているファイル名」を列挙する（区切りは `・`）。クリア操作で該当ペインの表示をリセットする。 |
| 対応行判定のブラッシュアップ（SQL日付整形の意図一致） | request | 5.2 行レベル差分 | `$sql .= ", to_char(date, 'yyyy/mm/dd')";` と `sql += ", FORMAT(date, 'yyyy/MM/dd')";` が replace として揃い、行内差分が出る（引数が違う場合は揃わない）。 |
| ノートPC幅でヘッダーのラベルが改行される | bug | 4.1 レイアウト | 狭幅ではラベルを省略し、操作エリアが1行で崩れない。 |
| 折り返し時にアンカー丸が複製される | bug | 8. アンカー行仕様 | アンカー丸は論理行の先頭に1つだけ表示され、折り返しで増えない。 |
| 複数ファイル読み込み時、前ファイル末行が次ファイル先頭に混入する | bug | 10.3 複数ファイル読み込み / 行番号仕様 | 2ファイル読み込みで file2 の先頭が必ず file2 の行1になる。末尾改行あり/なし、追加読み込みでも再現しない（画面確認済み）。 |
| 2ファイル読み込み時の順序調整（cshtml.cs → cshtml） | request | 10.3 複数ファイル読み込み | File.name に `*.cshtml` と `*.cshtml.cs` がある場合は `cshtml.cs` を先に読み込む。順序はテストで固定する。 |
| 文字コード選択UIの要否見直し（調査→実装） | request | 10.4.2 文字コード選択の扱い / 10.1 UI仕様 | 結論: UIは残す。理由: UTF-8 として妥当な ASCII/短文や Shift_JIS/EUC-JP の曖昧ケースで Auto が誤判定し得るため、手動復旧が必要。 | Auto の限界を仕様に明記する |
| Blob 要否調査（リリースビルド） | build | 13.3 リリース手順 / 12.1 配布物 | 使用箇所: Monaco の inline worker（`?worker&inline`）生成時に Blob URL を使用。単一HTML維持のため Blob は必須。外部依存ではないため許容する。 |
| Blob を使わない構成への移行 | build | 13.3 リリース手順 / 12.1 配布物 | Blob を外すには worker を別ファイル化する必要があり、単一HTML要件と相反するため見送り。機能デグレ回避を優先。 |
| ダークテーマ時の視認性向上（行内差分/オートアンカー） | bug | UI仕様 / 4.2 操作 | ダークテーマ＋ハイライトONでも行内差分が読め、hover/selectedでも潰れない。オートアンカー項目も読める配色になり、切替で即時反映される。 |
| 「差分なしの箇所を折りたたみ」表記の変更 | request | 4.2 操作 / UI仕様 | 文言を「差分のみ表示」に変更し、トグルUIとして表示される。旧文言が UI に残らない。 |
| 折り返しUI削除（Alt+Z は維持） | request | 4.2 操作 / UI仕様 | 折り返しトグルが UI から消え、Alt+Z で折り返しが切り替わる（案内表示は不要）。 |
| テーマトグルのデザイン改善 | request | UI仕様 / 4.2 操作 | ☀️/🌙トグルを月と太陽スイッチ風にし、ライトは太陽ノブ＋雲、ダークはクレーター月＋星を表示する。ノブは回転しながら移動し、`prefers-reduced-motion` では抑制する。SVG要素（太陽/雲/星/月）を埋め込んだスイッチとして実装済み。 |
| タイトル「Diff Viewer」のビジュアル改善 | request | UI仕様 | タイトルのタイポグラフィ/装飾を調整し、全体のトーンに合う見た目になる（ライト/ダークで可読性維持、1行のまま崩れない）。 |
| SVG favicon を埋め込みで提供 | request | 3.1 スタンドアロン保証 | `index.html` の `<head>` に `data:image/svg+xml` の favicon があり、`build:single` 後も単一HTMLで動作する。 |
| ファイル一覧のカード表示（視認性改善） | request | UI仕様 / 4.2 操作 / 10.3 複数ファイル読み込み | 読み込んだファイルがカードUIで横並び表示され、折り返さず横スクロールで全件確認できる。カードはファイル名のみで省略しない。ライト/ダークで破綻しない。 |
| ファイルカードクリックで該当ファイル先頭へジャンプ | request | UI仕様 / 4.2 操作 / 10.3 複数ファイル読み込み | ファイルカードクリックで該当ファイルの先頭行へジャンプする。スクロール連動OFF時はクリック側のみ移動し、ON時はスクロール同期に従って崩れない。 |
| 利用者向けマニュアル（doc/MANUAL.md） | docs | 4.3 利用者向けマニュアル | `doc/MANUAL.md` に利用者向けの手順がまとまり、file://直開きで使える点・基本操作・Ctrl/Cmd+G・差分/アンカーの見方が説明されている。Alt+Zの記載はしない。 |
| ワークスペース機能（タイトルUI化） | request | UI仕様 / 4.2 操作 | タイトルクリック/Ctrl+NでワークスペースUIを開閉。最大10件、名前は25文字以内、空文字不可。追加/削除/リネーム/ドラッグ並び替えができ、最後の1件は削除不可。タイトル表示は選択中のワークスペース名のみ。削除は確認ダイアログで確定。パス登録はワークスペース単位で保存し、旧キーは移行される。状態は localStorage に保存される。 |
| パス登録UIの開閉安定化とトースト通知 | bug | UI仕様 / 4.2 操作 | パス登録UIはデフォルト閉。閉じるは「閉じる」ボタン/外クリック/Esc/トグル再押下で動く。閉じたら元ボタンへフォーカスが戻る。コピー/追加/失敗はトースト通知で表示される。 |
| パス登録UIの表示整理（展開時のみ/縦積み/ドラッグ並び替え） | request | UI仕様 / 4.2 操作 | 展開時のみ一覧を表示。登録済みパスは縦積みブロックで表示し、ドラッグ&ドロップで並び替え。左右ペイン別に最大10件まで保存し、読み込み時に10件へ補正してUIの縦スクロールを発生させない。×ボタンは削除。文字入力で入力欄に即フォーカス。↑/↓で選択・Enterでコピー。Deleteで削除。Ctrl+P/Cmd+Pで展開トグル。最大10件がスクロール無しで表示される。 |
| エディタ上部のスコープ表示（関数/タグ等）を非表示にする | request | UI仕様 / エディタ表示 | エディタ上部に固定表示される関数名/タグ/ブロック等のバー（sticky scroll / scope header相当）が表示されない。差分・アンカー・折りたたみ等の既存機能はデグレしない。`build:single` でも非表示。 |
| 読み込み完了サマリを保持（リロード後も表示） | request | UI仕様 / 4.2 操作 / 10.3 複数ファイル読み込み | ファイル読み込みで「読み込み完了: ...」が表示され、リロード後も直前のサマリが表示される。新規読み込みで最新内容に更新される。クリア操作でサマリも消える（左右クリア/全クリアで確認）。 |
| 対応行検出のブラッシュアップ（StringBuilder生成コードのエスケープ耐性） | bug | 5.2 行レベル差分 | 生のJS/HTML/CSSとStringBuilder.AppendLine生成行がreplaceで揃う。\"や\\（円記号含む）でも対応が壊れず、行内差分でクォート/エスケープ差が見える。HTMLテンプレの `<?= ?>` / `$var` / C# `{var}` も replace で揃う。 |
| 対応行検出のブラッシュアップ（拡張子 .php の有無を軽微差として扱う） | request | 5.2 行レベル差分 | `document.excel.action = "foo_bar.php"` と `document.excel.action = "foo_bar"` がreplaceで揃い、`.php` 差分が行内差分として見える。 |

注記: 「複数ファイルの行番号再カウント」は不安定化バグとして再オープンしたが、修正済み。
