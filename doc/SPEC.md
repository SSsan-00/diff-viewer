# 差分ビュー作成 — 仕様書 v1.3（実装準拠 + 配布要件強化 + 読み込み/アンカー拡張）

変更点サマリ:
- 配布物ゲートを強化（外部依存を想起させる文字列の削除、modulepreload/polyfillの排除）。
- 単一HTMLの出力を「可読版」と「最適化版」に分離。
- LocalStorage による状態保存・復元を将来拡張として整理。
- 禁止文字列の検出方式を明確化（github/api の単語境界・大小文字）。
- 禁止文字列の検出スコープを明確化（script/style を除外する弱い禁止）。

VS Code の差分ビューを「だいたい同じ思想」で再現しつつ、最大の目的である **スクロール連動 OFF（独立スクロール）** を実現する。  
最終成果物は **HTMLファイル単体でスタンドアロン動作**（オフラインOK）とする。

この仕様書は「実装より先に挙動を固定し、テストで守る」ための単一の真実（Single Source of Truth）とする。

## 目次

- 方針（実装アーキテクチャ）
- VS Code に近い使用感の方針
- 用語
- ゴール（MVP / 拡張）
- 非機能要件（配布物の安全性・混入防止）
- UI仕様（MVP）
- 差分仕様（MVP / VS Code っぽさ）
- スクロール仕様
- 再計算仕様
- アンカー行仕様
- 折りたたみ仕様
- ファイル読み込み仕様
- 状態の永続化
- テスト方針（受け入れ条件）
- 実装制約（ビルド/パッケージ管理含む）
- 付録: diffEngine の差分モデル（案）

---

## 方針（実装アーキテクチャ）

- UI は **Monaco Editor を左右に2つ**配置して「VS Codeっぽい編集体験」を担保する
- 差分検出（行レベル/行内レベル）は **自前実装**し、結果を Monaco の **decoration（装飾）** で可視化する
- スクロール連動は本ツール側で制御し、**デフォルトON**／任意で **OFF（独立スクロール）** を提供する

> 目的は「VS Code の diff 表示と同様の挙動」を得ることだが、UI/スクロール制御の自由度を優先する。  
> 将来的に必要になれば、差分検出ロジックだけを Monaco/VS Code 側の実装へ差し替え可能な設計にする。

---

## VS Code に近い使用感の方針

本ツールは「見た目」だけでなく **差分の出方（ペアリング/ハイライトの粒度/ブロックのまとまり方）** も VS Code の差分ビューに近い体験を目指す。

- 目的は **同じ入力に対して、ユーザーが違和感の少ない差分表示** を得ること
- 厳密に同一アルゴリズムであることは必須ではないが、挙動の優先順位は次の通りとする
  1. 変更ブロックのまとまり方（どこが1つの変更として見えるか）
  2. 行のペアリング（replace の作り方）
  3. 行内ハイライトの粒度（変更箇所が細かすぎ/粗すぎにならない）

---

## 用語

- **左ペイン / 右ペイン**: 比較対象の2つのテキスト表示領域
- **フォーカス中のペイン**: Monaco エディタ上で最後にテキストフォーカスが当たったペイン
- **行**: `\n` で区切られた単位（CRLF は内部で LF へ正規化）
- **ファイル境界**: 複数ファイルを連結したときのファイル切り替え地点（表示上の区切りを持つ）
- **file-local line number（ファイル内行番号）**: 各ファイル内で 1 から数える表示用の行番号
- **差分**: 2つのテキストの比較結果（行レベル + 行内レベル）
- **アンカー行**: 手動で「この行同士は対応」と固定するための基準点

---

## 1. ゴール（プロダクト要件）

### 1.1 できること（Must / 実装済み）

1. **2つのテキストを表示し、差分を行単位で可視化**できる  
2. 差分箇所は **行内（部分一致）もハイライト**できる（VS Code っぽく）  
3. **スクロール連動はデフォルト ON**  
4. ユーザー操作で **スクロール連動 OFF（独立スクロール）** に切り替えできる  
5. 手動で体裁を整えた後、**差分を再計算**できる  
6. **前/次の差分へジャンプ**できる  
7. **アンカー行（手動で左右の対応付け）**を登録し、再計算に反映できる  
8. **変更の折りたたみ（変更ブロック単位）**の ON/OFF ができる  
9. **ファイル読み込み**（ドラッグ&ドロップ + ファイル選択）ができる  
10. **左右をクリア**できる  
11. **配布物（dist/index.html / dist/index.min.html）はHTMLファイル単体で動く**（利用者はビルド不要・オフラインOK）

### 1.2 できると嬉しい（Should / Later / 拡張）

- 大規模ファイル向けの高速化や差分精度改善
- 差分ミニマップなど視認性向上のUI

---

## 2. 非ゴール（最初はやらない）

- 巨大ファイル（数十万行）をスムーズに扱う最適化（後回し）
- 完全に VS Code のアルゴリズムと同一であること（“同じ思想”で十分）
- エディタ内容のファイル書き戻し（保存/上書き）は行わない

---

## 3. 非機能要件（配布物の安全性・混入防止）

### 3.1 スタンドアロン（オフライン）保証

- `dist/index.html` / `dist/index.min.html` を `file://` で直接開いて動作すること（ローカルサーバ不要）
- 実行時に外部ネットワークへアクセスしない（CDN/外部APIに依存しない）
- アイコンなど外部アセット参照を含めない（例: 既定の `vite.svg`）
- favicon は `data:image/svg+xml` の **埋め込み**で提供し、配布物の単一HTML要件を満たす

### 3.2 配布物に「特定文字列」を残さない（最重要のリリースゲート）

**最終成果物 `dist/index.html` / `dist/index.min.html` に、次の文字列が含まれていてはならない。**

- `http://`
- `https://`
- `GITHUB_WORKSPACE`
- API/GitHubなど外部依存を彷彿させる文字列（例: `github.com`, `api.github.com`, `raw.githubusercontent.com`）
- 単語としての `github` / `api`（大小文字は区別しない、単語境界でのみ検出）

意図：
- 外部参照（URL）を想起させる文字列を成果物に残さない
- CI環境（GitHub Actions等）のパスやメタ情報が成果物へ混入するのを防ぐ

#### 3.2.1 検査方法（必須）

- ビルド後に `dist/index.html` / `dist/index.min.html` を対象に **禁止文字列検査（ban words）** を行う
- 検査で1件でも検出したら **リリース失敗** とする
- 禁止文字列は **置換で回避しない**（ビルド/バンドル段階で含まれない状態にする）
- この検査は「手動リリース手順」および「CI（将来導入）」の両方に組み込む
- 検出方式のルール:
  - `http://` / `https://` は **部分一致**で検出する（出現した時点でNG）
  - `GITHUB_WORKSPACE` / `github.com` / `api.github.com` / `raw.githubusercontent.com` は **部分一致**で検出する
  - `github` は **単語境界**でのみ検出し、大小文字は区別しない
    - `<script>` / `<style>` を含む **成果物全体**を検査対象とする
  - `api` は **単語境界**でのみ検出し、大小文字は区別しない
    - 検出対象は **HTMLの見える領域・属性**に限定する（`<script>` / `<style>` は対象外）
    - 例: `minimapIsSampling` は OK、UI文言に `API` が入るのは NG

### 3.3 SourceMap・ビルドメタ情報の混入禁止

- `dist/index.html` / `dist/index.min.html` に SourceMap 参照（`sourceMappingURL`）を含めない
- inline sourcemap（base64埋め込み等）も禁止
- 検査回避のための文字列置換は禁止（SourceMapが出ない設定を優先する）
- 理由：ローカルパス/CI由来パス（例：`GITHUB_WORKSPACE`）の混入原因になりやすいため

### 3.4 modulepreload / polyfill の混入禁止

- `dist/index.html` / `dist/index.min.html` に modulepreload の **polyfill 関数**を含めない
- modulepreload を無効化するなど、ビルド段階で混入しない状態を保証する

---

## 4. UI仕様（MVP / 最小構成）

### 4.1 レイアウト

- 画面は左右2カラム
- 最上部に **ツールバー**
- ツールバー直下に **アンカーパネル**
- 各カラムの上部にファイル読み込みUI（文字コード選択 + ファイル選択）
  - **ファイル選択 UI は各ペインの左側**に配置する
  - ヘッダ/ツールバーの縦幅を増やさない（増える場合は仕様として明記する）
  - 画面幅が狭い場合はラベルを省略して、操作エリアが1行に収まるようにする
- 各カラムの下部に **Monaco Editor** を配置（左右で2つの通常エディタ）
- エディタ上部に固定で出るスコープ表示（sticky scroll 相当）は表示しない

### 4.2 操作

- `スクロール連動` ON/OFF トグル
- `差分再計算` ボタン
- `次の差分 / 前の差分` ボタン
- `差分のみ表示` トグル（UI で切替。既存の「差分なし折りたたみ」挙動をそのまま使う）
- 折り返しは UI を持たず、Alt+Z で左右同時に切替する（UI上の案内は出さない）
- `クリア` ボタン（左右のテキストとアンカーを全消去）
- 左右ペイン別の `クリア` ボタン（各ペイン右上。対象ペインのみテキストを消去し、**アンカーは両側とも全消去**）
- クリア操作は Undo 可能（Ctrl/Cmd+Z）。Undo はテキストのみ復元し、アンカーは復元しない
- 各ペインの上部に **ファイルカードバー** を表示する（ファイル名のみ、折り返さず横スクロールで全件確認）
- ファイルカードクリックで **該当ファイルの先頭行へジャンプ**する
  - スクロール連動OFF: クリックした側のみ移動
  - スクロール連動ON: スクロール同期の挙動に従い、崩れないことを優先する
- 各ペインに **お気に入りパス登録** を用意する（左/右で別保存）
  - クリア右側の「パス登録」で開くポップオーバーに入力して追加する（最大10件、重複は追加しない）
  - デフォルトは閉じた状態で開始する
  - 登録済みパス一覧は **展開中のみ表示** し、縦積みブロックで表示する
  - 表示件数は最大10件に補正し、展開時でも縦スクロールを発生させない
  - 閉じる操作は「閉じる」「Esc」「外クリック」「トグル再押下」に対応し、閉じたら元のボタンへフォーカスを戻す
  - パスのクリックでクリップボードへコピーする（失敗時は通知）。コピーは常に実行を試み、空文字の場合のみ無効とする
  - 並び替えは **ドラッグ&ドロップ** で行い、削除は削除ボタンで実行する
  - 展開中のみ ↑/↓ で選択を移動、Enter で選択中パスをコピーする（一覧はフォーカス可能）
  - 選択中は Delete で削除する（入力欄フォーカス中は入力編集を優先）
  - 文字入力や Backspace は入力欄へフォーカスを移動する（Ctrl/Cmd/Alt/Meta 押下時と Enter/Esc/Tab は除外）
  - Ctrl/Cmd+P でパス登録UIをトグルする（最後に操作したペインを対象、未判定なら左）
- 折り返しは Alt+Z で左右同時に切替し、切替後は **レイアウト確定後に再計算** してズレない
- `ハイライト` トグル（画面ヘッダで左右同時に切替。OFF は `plaintext` に切替、ON は拡張子推定で言語を設定）
- ハイライトの ON/OFF は `data-highlight="on/off"` を付与し、ダークテーマ時は inline diff の配色が読みやすくなるよう CSS トークンで切り替える
- Ctrl/Cmd+F で、フォーカス中のペインに Monaco の検索UIを開く（フォーカス不明時は最後にフォーカスされたペインを優先）
- Ctrl/Cmd+G で、フォーカス中ファイルを既定にした行ジャンプUIを開く
  - ファイル選択UIで対象ファイルを切替でき、入力する行番号は **ファイル単位 (1..N)** とする
  - スクロール連動OFFではジャンプは片側のみ（対象ペインのみ移動）
- Ctrl/Cmd+J で左ペインへフォーカス移動（移動元カーソル行と同じ縦位置の行の先頭へ、取得できない場合は表示最上行へ）
- Ctrl/Cmd+K で右ペインへフォーカス移動（移動元カーソル行と同じ縦位置の行の先頭へ、取得できない場合は表示最上行へ）
- 行ジャンプUI表示中は Ctrl/Cmd+J/K でファイル選択を左右移動（←/→と同等）
- ☀️/🌙 トグルでライト/ダークテーマを切り替える（**月と太陽のスイッチ風UI**、即時反映）
- タイトル「Diff Viewer」は専用スタイルで視認性を上げる
  - 太めのウェイトと余白を持つ“プレート”風。細いアクセントラインで控えめに装飾する
  - ダーク/ライト両テーマで可読性が落ちないよう配色を切り替える（過剰な装飾は避ける）
  - テーマトグルは **SVG（太陽/雲/星/月）** を埋め込んだスイッチで表現する
  - ライト時は太陽ノブ＋雲、ダーク時はクレーター月＋星が見える
  - 切替時はノブが回転しながら移動する（200〜450msの範囲、`prefers-reduced-motion` では抑制）
  - 色の切替は 150〜300ms 程度のトランジションで滑らかに反映し、`prefers-reduced-motion` では無効化する
- ダークテーマでは行内差分ハイライトとオートアンカー項目（hover/selected含む）、ファイル境界のファイル名表示が十分に判別できる配色を維持する
- アンカーパネル
  - アンカー一覧（クリックでジャンプ）
  - 削除ボタン
  - 無効アンカーの警告表示
  - 折りたたみ/展開トグル（ヘッダーのトグルと同一UI/属性で、アンカー情報は保持。折りたたみ時も一覧は表示し、**2件分の固定高 + 縦スクロール** で確認できる）

### 4.3 利用者向けマニュアル

- 利用者向けの手順書は `doc/MANUAL.md` に置く。
- UI/操作/表示仕様に変更があった場合は **MANUAL.md も更新**する（実装と一致させる）。

---

## 5. 差分仕様（MVPの核 / VS Code っぽさ）

### 5.1 正規化

- 入力テキストの改行は内部で `\n` に統一する
- 末尾改行の有無は「差分として扱う」（VS Code 挙動に寄せる）

### 5.2 行レベル差分

- 差分検出アルゴリズムは **Myers系（最短編集スクリプト）を基本**とし、VS Code/Monaco の一般的な差分挙動に近づける
- 将来的な差し替えに備え、差分検出は `diffEngine` として UI から分離し、入力（左右テキスト）→出力（差分モデル）を純粋関数で扱う
- 大きな乖離があっても後半の共通ブロックが揃うよう、**ユニーク行を優先して対応付け**する（アンカーがある場合はアンカー分割が最優先）
- 言語差で表記が異なる場合も、**識別子/リテラル/宣言カテゴリの正規化**で対応付けを試みる（完全一致/アンカーを優先し、誤マッチは避ける）
- PHPタグで包まれた `{}` は **replace で対応付け**し、equal にはしない（行内差分で `<? ?>` やインデント差が見える）
- 文字列として構築された CSS/JS/HTML 本体は **文字列リテラル内容の正規化**で replace を成立させる（equal にはせず行内差分で差を見せる）
  - HTMLテンプレの `<?= ?>` / `$var` / C# `{var}` は **比較キーではプレースホルダ化**し、replace で揃える（equal にはしない）
- `} else {` と `else` のように **else を含む行の改行差**は、else 行を replace で対応付ける（`}` と `{` は insert/delete のまま残る）
  - `AppendLine` / `Append` / `+=` のような「文字列構築」を抽出し、HTMLタグ/主要属性や JS のキーワード/DOM API などを **補助トークン**として加点する
  - 属性順序の違いなどで一致扱いにはせず、**対応行として揃える**ことを優先する
- StringBuilder 生成行の比較キーは **エスケープを軽く正規化**する（`\"`/`\\`/`¥` は同一視）
  - 表示用の元行は維持し、クォートやエスケープ差は行内差分として可視化する
- 文字列リテラル末尾の `.php` 有無は **軽微差として対応行に揃える**（equal にはしない）
- **インデント差のみ**の行は **対応行として揃えるが一致扱いにはしない**（行内差分で空白差を表示する）
  - コメント行や単独キーワード/記号（`break;`/`else`/`{`）も対象とする

- 行配列にして比較し、以下の種類を返す
  - `equal`（同一行）
  - `insert`（右にだけ存在）
  - `delete`（左にだけ存在）
  - `replace`（左右で異なるが対応する行として並べる）

#### 5.2.1 replace の作り方（VS Code っぽさのための規則）

Myers の結果は基本的に `insert`/`delete` の列として得られるため、表示上の `replace` は次の規則で生成する。

- 連続する `delete` ブロックの直後に連続する `insert` ブロックが続く場合、それらを **1つの変更ブロック** とみなす
- 変更ブロック内で、`delete` と `insert` は **行のペアリング** を行い、ペアになった行を `replace` として扱う
- ペアリングは次の優先順位で決める
  1. **同じインデント（先頭の空白/タブの量が近い）** を優先
  2. 文字列の類似度（例: 文字単位の共通部分が多い）を優先
  3. それでも決まらない場合は、上から順に対応付け（安定性を優先）
- ペアにならなかった余りは `delete` または `insert` のまま残す
- ただし **一致（equal）は元文字列の厳密一致のみ** とし、識別子が異なるが構造が近い行は `replace` として並べる
  - 例: `StringBuilder.AppendLine("...")` と `$sql .= "..."` は `replace` として揃える
  - 例: `StringBuilder sql = new();` と `$sql = ""` は `replace` として揃える
  - 例: `to_char(date, 'yyyy/mm/dd')` と `FORMAT(date, 'yyyy/MM/dd')` は **文字列リテラルが近い場合** に `replace` として揃える
  - 例: `}` のようなブレース単独行は、直前の対応行が揃っている場合に `replace` として揃える
  - 例: `} else {` と `else` は **else 行のみ** を `replace` として揃える（括弧は insert/delete のまま）
  - 例: 関数宣言や代入は **同カテゴリ・同名** の場合のみ `replace` として揃える（`test` と `test2` / `foo` と `food` は対象外）

> 目的は「削除→追加」が並ぶケースを、ユーザーが自然に「置換」として読める形に寄せること。

- 表示は **左右で同じ縦位置に揃う**
  - 置換・挿入・削除でズレる部分は「表示上のスペーサー」で整列する
  - **エディタ本文（左右のテキスト）には空行を挿入しない**（表示専用の調整として扱う）
  - 実装は Monaco の viewZones 等の仕組みで高さ調整する想定（詳細は実装時に決める）

### 5.3 行内差分（部分ハイライト）

行内差分は `replace` 行にのみ適用し、左右両方に対して変更範囲を算出する。
（インデント差や空白差も差分として可視化する）

※ range は「行内の 0-based 文字インデックス範囲（start は含む / end は含まない）」として扱う。

- ルール（MVP）
  - 基本は **文字単位** で差分を取り、左右それぞれの「変更された範囲（range）」を返す
  - 差分が極端に細かく分断されて視認性が落ちる場合は、隣接する小さな差分範囲を結合して表示して良い（視認性優先）
  - 空白のみの差分も MVP では差分として扱う（空白無視は拡張要件）
  - `diffEngine` の差分モデルを元に、**Monaco の decoration** でインライン強調表示する

---

## 6. スクロール仕様（最重要）

### 6.1 連動 ON 時

- 左をスクロールすると右も追従（逆も同様）
- **無限ループ防止**
  - 片方のスクロールイベントがもう片方を呼び続けない仕組みを必須とする

### 6.2 連動 OFF 時

- 左右は完全に独立してスクロール
- 差分ジャンプ（前/次）を実行した場合は、連動 OFF でも **左右両方を同じ差分ブロック先頭行** にスクロールして揃える

---

## 7. 再計算仕様

- テキスト編集時は **デバウンス（目安: 200ms）で自動再計算** する
- `差分再計算` を押すと **即時に再計算** し、現在の左右テキストから差分モデルを再生成して再描画する
- 再計算は **in-flight の重複実行を避ける**（実行中に追加要求が来たら完了後に1回だけ追従）
- ファイル読み込み、アンカー追加/削除時も明示的に再計算する
- 折り返し切替時はレイアウト確定後に再計算し、差分/アンカーの対応行がズレないようにする
- Monaco のレイアウト変化（検索UI/Find Widget の開閉など）でも再計算をスケジュールし、対応行の縦位置を揃える
- 折り返しON時は **論理行の表示高さが可変** になるため、視覚的な揃いはベストエフォートとする
  - 対応行の基準は「論理行の先頭」に寄せる
  - レイアウト確定後の再計算でズレを最小化する

---

## 8. アンカー行（手動対応付け）

目的: 自動差分が迷うケース（同一行の繰り返し、並べ替え、長いブロック変更など）で、ユーザーが「この行同士は対応」と固定できるようにする。

### 8.1 UI仕様

- 左右それぞれの行番号領域（gutter）をクリックしてアンカーを付けられる
- アンカーは「左の行番号」と「右の行番号」のペアとして登録する
- アンカーは一覧表示でき、クリックで該当行へジャンプできる
- アンカーは一覧から削除できる
- 同じ行をクリックするとアンカーが削除される
- 片側だけ選択中の状態で同じ行を再クリックすると、選択を解除してマーカーを消す
- アンカー丸マーカーは **論理行の先頭に1つだけ**表示し、折り返しで複製されない
- アンカーは行番号ベース（0-based）で保持し、テキスト編集により行番号がずれた場合はユーザーが貼り直す（自動追従はしない）
- アンカーの **表示行番号は file-local line number** とする
- どのファイルの行か分かる視覚的区別（色/バッジ/区切り等）を用意する

### 8.2 差分への反映

- 再計算時、アンカーを境界としてテキストを **セグメント分割** して差分を取る
  - 例: (L10 ↔ R12) がアンカーなら、
    - 先頭〜L9 / 先頭〜R11 を差分
    - L10 / R12 は `equal` 扱い（または `replace` 扱い）で固定
    - L11〜末尾 / R13〜末尾 を差分
- アンカーが矛盾している場合（順序が逆転するなど）は、無効として扱いログに残す

#### 8.2.1 アンカー検証ルール（Phase A）

アンカーはユーザー入力のため、再計算時に次のルールで検証し、満たさないものは無効として扱う（UIに警告しログにも残す）。

- 範囲外（左右いずれかの行番号が存在しない）は無効
- 左右それぞれの行番号は、アンカー一覧を `leftLineNo` 昇順で並べたときに `rightLineNo` も単調増加である必要がある
  - 例: (L10↔R12) の後に (L9↔R20) は無効（順序逆転）
  - 例: (L10↔R12) の後に (L11↔R11) も無効（右側が逆転）
- 同じ `leftLineNo` または同じ `rightLineNo` を複数のアンカーで共有することは禁止（重複は無効）
  - 実装上の警告文言: `範囲外` / `左行の重複` / `右行の重複` / `順序逆転`

### 8.3 自動アンカー（DOCTYPE）

目的: HTML等で共通の起点（DOCTYPE）を自動的に対応付けし、差分の迷いを減らす。

#### 8.3.1 仕様

- 再計算時（`差分再計算` 実行時）に、左右のテキストを行単位で走査し、次の条件を満たす場合に自動アンカーを追加する:
  - 左右それぞれに、行内に `<!DOCTYPE` を含む行が存在する

- 自動アンカーは、左右の **最初に見つかった DOCTYPE 行同士** をペアとして **1件だけ** 作成する（MVP）
  - 将来拡張で複数対応は可能だが、MVPでは1件に限定し安定性を優先する

#### 8.3.2 文字の揺れ（許容）

- 検出対象は原則 `<!DOCTYPE`（ASCII）だが、誤入力の揺れとして `<！DOCTYPE`（全角 `！`）も同等に扱ってよい

#### 8.3.3 既存アンカーとの関係

- 手動アンカーが存在する場合でも自動アンカーを追加してよい
- ただし自動アンカーが既存アンカーと矛盾（順序逆転/重複など）する場合は、
  - 自動アンカーは **無効扱い（追加しない）**
  - ログに理由を残してよい（任意）

#### 8.3.4 UI表示（任意）

- 自動アンカーをアンカー一覧に表示してよい
  - 表示する場合は `AUTO:DOCTYPE` など自動生成であることが分かるラベルを付ける
- 自動アンカーの削除UIは任意（MVPでは「手動のみ削除可能」でもよい）

---

## 9. 変更の折りたたみ（変更ブロック単位）

目的: 変更の無い `equal` 領域を省略し、差分ブロックに集中できるようにする。

### 9.1 表示ルール

- 連続する `equal` 行が一定数（8行）を超える場合、中央部分を折りたたむ
- 折りたたみは「`... 省略（N行） ...`」のようなプレースホルダ行として表示する
- プレースホルダをクリックすると展開/再折りたたみできる
- 折りたたみ対象の前後は **先頭3行/末尾3行** を残す

### 9.2 注意

- エディタ本文は変更しない（折りたたみも表示専用）
- 差分ジャンプは、折りたたまれていても正しく差分ブロックへ移動できる

---

## 10. ファイルのドラッグ&ドロップ（左右に読み込み）

目的: コピペではなくファイルから素早く比較できるようにする。

### 10.1 UI仕様

- 左ペイン/右ペインそれぞれに「読み込みUI」を用意する
  - ファイル選択（`<input type="file">`）
- ファイル選択は **複数選択**できる（`multiple`）
- ドラッグ&ドロップも **複数ファイル**に対応する
- ファイルをドロップ、またはファイル選択したら、その内容を該当ペインに読み込んで表示する
- 読み込み完了メッセージは「現在そのペインに読み込まれているファイル名」を **全て列挙**する（区切りは `・`）
- 全体クリア/ペイン別クリアの操作では、対象ペインの読み込み完了メッセージもクリアされる
- 読み込み完了メッセージは localStorage に保存し、リロード後も直前のサマリを表示する
- 読み込み失敗時は **ファイル名を含むメッセージ**を表示する
  - TDZ系の初期化エラーは「読み込みに失敗しました」に統一する
  - それ以外の失敗は `Error.message` を表示してよい（ログは可）
- 対応ファイルはテキスト（UTF-8 / Shift_JIS / EUC-JP を想定）
- 表示するファイル名は `File.name` の大小文字を保持する
- ドロップは **ペイン全面で受け付ける**（固定文言のドロップ領域は設けない）
- ドロップ可能状態の **視覚フィードバック**（枠線/ハイライト等）を定義する

- シンタックスハイライトは拡張子から推定した言語を **ペイン単位**で適用する
  - 複数言語が混在する場合は、以下の優先順位で **1つの言語**を決定する
    - `csharp` → `php` → `html` → `typescript` → `javascript` → `css` → `json` → `markdown` → `plaintext`
  - 対応拡張子（最小セット）:
    - `.php` → `php`
    - `.inc` → `php`
    - `.cs` / `.csx` / `.cshtml` / `.cshtml.cs` → `csharp`
    - `.js` / `.mjs` / `.cjs` → `javascript`
    - `.ts` / `.tsx` → `typescript`
    - `.html` / `.htm` → `html`
    - `.css` → `css`
    - `.json` → `json`
    - `.md` → `markdown`
    - 不明 → `plaintext`
  - トグルON時は Monaco 標準の言語定義によりトークン化され、表示が変化すること
  - ワーカーは language label ごとに割り当て、診断/補完等の要求でエラーが出ないこと

- 文字コード（エンコーディング）をペインごとに選択できる
  - 既定: `自動`
  - 選択肢: `UTF-8` / `Shift_JIS` / `EUC-JP` / `自動`
  - `自動` は **混在文字コード**に対応するため、ファイル単位の推定デコードを行う（10.4）

- 実装注意（ブラウザの既定動作を抑止）
  - ドラッグ&ドロップ時は `dragover` / `drop` で `preventDefault()` しないと、ブラウザがファイルを「ページ遷移」として開こうとして失敗する場合がある（例: `about:blank#blocked`）
  - ペイン全体だけでなく、アプリ全体（window/document）でも `dragover` / `drop` の既定動作を抑止しておく

### 10.2 セキュリティ/制約

- ブラウザ標準の File API（file.arrayBuffer() / FileReader）と Encoding API（TextDecoder）のみを使用する
- オフライン/スタンドアロン動作の範囲内で完結する（外部アップロードはしない）
- `file.text()`（Blob.text()）は常に UTF-8 想定でデコードされるため、Shift_JIS/EUC-JP などの読み込みには `arrayBuffer` + `TextDecoder(label)` を用いる
- TextDecoder の `label` には `shift_jis` / `euc-jp` を指定できる（Encoding Standard に準拠）
- ファイル読み込みはブラウザ内で完結させ、ドロップ/選択をトリガーにページ遷移（ナビゲーション）を発生させない
- ペイン外へのドロップでもページが置き換わらないよう、document/window レベルで既定動作を抑止する

### 10.3 複数ファイル読み込み（連結ルール）

目的: 複数ファイルを一括読み込みし、比較準備を高速化する。

#### 10.3.1 入力（ファイル選択 / ドラッグ&ドロップ）

- ファイル選択は複数ファイルを選べる（`multiple`）
- ドラッグ&ドロップも複数ファイルを受け付ける

#### 10.3.2 連結順序

- 連結順序は **選択/ドロップで得られた FileList の順序**を採用する
  - これはブラウザが提供する順序であり、ユーザーの選択順序が保持されることを期待する
  - もし環境差で順序が変わる場合でも、実装は FileList の順序に従う（安定性優先）
- ただし `*.cshtml` と `*.cshtml.cs` が同一ベース名で混在する場合は、**`*.cshtml.cs` を先に読み込む**

#### 10.3.3 連結方法（改行ルール）

- 読み込み先のエディタに既に内容がある場合：
  - 末尾が改行（`\n`）で終わっていなければ **`\n` を1つ追加**してから追記する
- 複数ファイルを連結する場合：
  - ファイルAの内容の末尾が改行で終わっていなければ **`\n` を1つ追加**してから次のファイルBを追記する
- 結果として、ファイル境界では **必ず1つ以上の改行で区切られる**（ただし改行を過剰に増やさない）
- 次のファイルBの先頭行は **必ず file-local line number の 1 行目**として扱われ、前ファイル末行が混入しない

#### 10.3.4 ファイル境界の表示（見た目の余白）

- ファイル境界は **表示上の余白**や区切りで視認できるようにする
- 余白は **論理行番号に影響させない**（差分/アンカーの行番号は元テキストの行番号を維持）
- file-local line number と表示余白の区別が混同されないようにする
- 左右でファイル数が異なる場合でも、**対応行の縦位置がズレない**ように余白の挿入位置を揃える

#### 10.3.5 行番号の再カウント（表示）

- 複数ファイルを追加読み込みした場合、**後から追加したファイルの行番号表示は1から再カウント**する
- 行番号の再カウントは **表示上の責務**に留め、差分ロジックの行番号は実テキストの行番号を維持する

#### 10.3.6 正規化

- 各ファイル内容は読み込み後、内部で改行を `\n` に正規化する（CRLF/CR は LF に統一）

### 10.4 混在文字コードの読み込み（文字化け防止）

目的: 複数ファイル読み込み時に、ファイルごとに文字コードが異なっても文字化けせず表示できるようにする。

#### 10.4.1 デコード単位

- **ファイル単位**でデコードする（連結してから一括デコードしない）
  - 理由: 混在文字コードのため

#### 10.4.2 ペインの文字コード選択の扱い

- 各ペインの文字コード選択は「優先設定」として扱う
- 実装は次の方針に従う：
  - ペインが `UTF-8` / `Shift_JIS` / `EUC-JP` の場合：
    - 原則その指定でデコードする
    - ただし極端な文字化け（置換文字 `U+FFFD` が多すぎる等）が検出される場合は、`自動` と同等の推定にフォールバックしてよい（混在対応を優先）
  - ペインが `自動` の場合：
    - 常に 10.4.3 の推定手順でデコードする
- `自動` は ASCII のみ/短文など **判別が曖昧**なケースがあるため、手動で切り替えられる UI を維持する
- 読み込み時の **元バイト列（rawBytes）はペイン単位で保持**し、文字コード変更時は **同じバイト列を再デコード**して表示を更新する
- rawBytes が無い場合（手入力のみ/再起動直後など）は、再デコードを行わず表示を維持する

#### 10.4.3 自動推定（Auto）の推定手順（MVP）

ファイルごとに次の手順で推定する：

1. BOM があれば BOM に従う
2. UTF-8 を厳密デコード（不正なら失敗）
3. UTF-8 で失敗した場合、`shift_jis` と `euc-jp` を試し、**置換文字（U+FFFD）が最も少ない**ものを採用する
4. 置換文字数が同点の場合は、**日本語文字（ひらがな/カタカナ/漢字）の多い方**を優先する
5. それでも判定が付かない場合は Shift_JIS を優先する（日本語ファイルでの実用性優先）

- 推定結果（採用したエンコーディング）はログに残してよい（デバッグ用）

#### 10.4.4 推定で解決できない場合

- 推定結果がどれも不自然（例: 置換文字が極端に多い等）の場合は、読み込みを中断し
  - 「文字コードを選択してください」を表示してよい
  - このエラー/警告は **ファイル単位**で発生し得る

#### 10.4.5 制約

- 使用するAPIはブラウザ標準の File API と TextDecoder のみ（外部ライブラリ不可）

---

## 11. 状態の永続化（LocalStorage）

目的: 再読み込み後も作業状態を復元し、検証や比較の再現性を高める。

### 11.1 保存対象

- 左右ペインのテキスト
- スクロール連動 ON/OFF
- 変更ブロックの折りたたみ ON/OFF
- アンカー一覧（手動/自動の区別を含む）
- 文字コード選択（左/右）
- アンカーパネルの折りたたみ状態
- テーマ（ライト/ダーク）は `diff-viewer:theme` に別保存する（メインの状態とは独立）
- 複数ファイルの行番号表示に必要なファイル境界情報（ファイル名/行数など）

※ 差分計算結果や装飾そのものは保存せず、復元後に再計算する。

### 11.2 復元タイミング

- 起動時（初回ロード時）に保存があれば自動で復元する
- ファイルインポート時はその操作結果を保存し、直後の復元は行わない

### 11.3 クリア時の扱い

- 全体クリアは保存データを削除し、次回起動時に復元されない状態にする
- ペイン別クリアは該当ペインの内容/読み込みメッセージを空にし、保存データを更新する（テーマの保存は維持）

---

## 12. テスト方針（仕様駆動の骨）

### 12.1 受け入れ条件（MVP）

- 同一テキスト同士を比較した場合、差分ブロックは 0 件で、行/行内ハイライトは付かない
- 右側に1行追加した場合、その行は `insert` として右側の行全体がハイライトされる（左側は表示上スペーサーで整列）
- 左側に1行だけ存在する行は `delete` として左側の行全体がハイライトされる（右側は表示上スペーサーで整列）
- `delete` ブロックの直後に `insert` ブロックがあるケースは、可能な限り `replace` としてペアリングされ、行内ハイライトが適用される
- スクロール連動 ON では左右が追従し、OFF では追従しない（無限ループしない）
- `差分再計算` を押すと、現在の左右テキストに基づいて差分表示が更新される
- アンカー行を設定した状態で `差分再計算` すると、アンカー行の対応が固定され、前後の差分がアンカーを境界に計算される
- 変更の折りたたみが有効な場合、一定数以上の `equal` 行が省略表示され、クリックで展開できる
- ファイルを左/右にドロップ、またはファイル選択で読み込むと内容が表示され、`差分再計算` で差分表示が更新される
- ドラッグ&ドロップ操作でブラウザがページ遷移しない（`about:blank#blocked` 等が発生しない）
- Shift_JIS / EUC-JP のファイルを読み込む場合でも、文字コード選択（または自動判定）により文字化けせずに表示できる
- 逆転・重複・範囲外のアンカーは無効として扱われ、UIに警告が表示される

#### 12.1.1 追加受け入れ条件（読み込み拡張 / 自動アンカー）

- ファイル選択で複数ファイルを選んだ場合、FileList の順序で連結されて読み込まれる
- 既に内容があるペインに追加読み込みした場合、末尾に改行を挟んで追記される
- ドラッグ&ドロップでも複数ファイルが同様に連結される
- 複数ファイル時の **表示行番号は file-local** で安定し、追加読み込みでも 1..N で表示される
- ファイル境界の表示余白は **論理行番号やアンカー** に影響しない
- アンカー一覧の行番号表示は **file-local** で、どのファイルか判別できる
- 複数ファイルで文字コードが混在（UTF-8 / Shift_JIS / EUC-JP）していても、ファイル単位のデコードにより文字化けせず表示できる
- 左右に `<!DOCTYPE`（または `<！DOCTYPE`）が存在する場合、差分再計算時にその行同士が自動アンカーとして扱われる（矛盾時は追加しない）

#### 12.1.2 配布物受け入れ条件（追加 / 最重要）

- `dist/index.html` / `dist/index.min.html` は **単一ファイル**で動作する（追加の `.js` / `.css` / `.map` を必要としない）
- `dist/index.html` / `dist/index.min.html` は **同一のレイアウト**で表示される（主要UIの配置が一致する）
- `dist/index.html` / `dist/index.min.html` に **禁止文字列**（3.2）が含まれない
- `dist/index.html` / `dist/index.min.html` に SourceMap 参照や inline sourcemap が含まれない（3.3）
- `dist/index.html` / `dist/index.min.html` に modulepreload の polyfill 関数が含まれない（3.4）
- 禁止文字列・SourceMapの回避を **事後置換で行わない**

### 12.2 テスト階層

- **ユニットテスト**: 差分エンジン（入力→差分モデル）
- **ユニットテスト**: 行内差分（2文字列→ハイライト範囲）
- **DOMテスト**: トグル操作でスクロール連動が切り替わる
- **配布物検査テスト**: `dist/index.html` / `dist/index.min.html` に禁止文字列/SourceMap/modulepreload polyfill が含まれないこと（置換なし）
- **E2E は後回し**（まず Vitest + Testing Library で十分）

### 12.3 最初に書くべきテスト（MVPの最短ルート）

1. 行差分：同一、挿入、削除、置換の最低ケース  
2. スクロール連動：ON で追従する、OFF で追従しない  
3. 再計算：編集→ボタン→差分更新される  
4. 配布物検査：禁止文字列/SourceMap/modulepreload polyfill が混入していない（可読版/最適化版）  
5. 読み込み拡張：複数ファイル連結/追記の改行ルール、混在文字コード（Auto推定）  
6. 自動アンカー：DOCTYPE が双方にあるとき 1件追加、矛盾時は追加しない  

---

## 13. 実装制約（プロジェクト要件）

- VS Code 上で開発
- CODEX エージェントで進める
- UI は Monaco Editor（左右に通常エディタ2つ）を採用する
- 差分検出は `diffEngine` として独立させ、差分モデルを Monaco decoration に変換して表示する
- スクロール連動はツール側で制御し、デフォルトON／任意でOFFを提供する
- 成果物は **単一HTMLでスタンドアロン動作**
  - 開発中は Vite/TypeScript/テスト導入 OK
  - 最終成果物として `dist/index.html` / `dist/index.min.html` が単体で動く形に落とす（ビルドでインライン化）
  - Monaco の worker は **inline worker** として組み込み、実行時に Blob URL を用いて起動する（単一HTML維持のため許容）
- 一部環境で dev/preview が権限エラーで起動できない場合は、`pnpm build` 後に `dist/index.html` を `file://` 直開きで確認する

### 13.1 パッケージマネージャー（npm → pnpm）

- パッケージマネージャーは **pnpm** を採用する
- `package-lock.json` は使用しない（削除対象）
- lockfile は `pnpm-lock.yaml` を正とする
- CI/再現性の観点から、インストールは `--frozen-lockfile` 相当の運用を前提とする（ローカルでも推奨）

### 13.2 ビルド成果物の種類

- `dist/index.html` は読みやすさ重視の可読版（改行・インデントあり）
  - `<style>` 内 CSS は **見た目の一致を優先**し、崩れの要因になる整形は行わない（可読性は可能な範囲で担保）
  - 可読版でもコメントは除去し、禁止文字列（URLなど）が混入しないようにする
- `dist/index.min.html` は最適化版（フル minify で問題ない）
- どちらも外部参照なしで動作する単一HTMLとする
- minify の有無で **DOM 構造や CSS 適用順序が崩れない**こと
- 可読版/最適化版の **見た目は同一**であること（レイアウト差が出ない）
- modulepreload の polyfill を含めないため、ビルド設定で modulepreload を無効化する

### 13.3 リリース手順（必須ゲート）

1. `pnpm install`（ロック固定運用）
2. `pnpm run build`（または単一HTML生成用の build コマンド）
3. `dist/index.html` / `dist/index.min.html` が生成されていること
4. `dist/index.html` / `dist/index.min.html` を `file://` 直開きで主要機能が動くこと
5. **禁止文字列検査（3.2）に合格**していること
6. **SourceMap混入が無い（3.3）**こと
7. **modulepreload polyfill が混入していない（3.4）**こと
8. **検査回避のための置換を行っていない**こと

---

### 13.4 ドキュメント要件

- `doc/STRUCTURE.md` を新規作成し、主要ディレクトリと役割を一覧化する
- 構成変更が入る場合は同じPR/コミットで `doc/STRUCTURE.md` を更新する

## 付録: diffEngine の差分モデル（案）

diffEngine は UI に依存しない純粋なデータを返す。
（Monaco への変換は別レイヤで行う）

### 行レベル

- `LineOp`
  - `type`: `equal | insert | delete`
  - `leftLine?: string` / `rightLine?: string`
  - `leftLineNo?: number` / `rightLineNo?: number`（元テキスト上の行番号）

- `PairedOp`
  - `type`: `equal | insert | delete | replace`
  - `leftLine?: string` / `rightLine?: string`
  - `leftLineNo?: number` / `rightLineNo?: number`

### 行内レベル（replace 行のみ）

- `Range`
  - `start: number`（含む）
  - `end: number`（含まない）

- `InlineDiff`
  - `leftRanges: Range[]`
  - `rightRanges: Range[]`
