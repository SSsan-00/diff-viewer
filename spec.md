# 差分ビュー作成 — 仕様案 v0（MVP→拡張）

VS Code の差分ビューを「だいたい同じ思想」で再現しつつ、最大の目的である **スクロール連動 OFF（独立スクロール）** を実現する。  
最終成果物は **HTMLファイル単体でスタンドアロン動作**（オフラインOK）とする。

この仕様書は「実装より先に挙動を固定し、テストで守る」ための単一の真実（Single Source of Truth）とする。

## 目次

- 方針（実装アーキテクチャ）
- VS Code に近い使用感の方針
- 用語
- ゴール（MVP / 拡張）
- UI仕様（MVP）
- 差分仕様（MVP / VS Code っぽさ）
- スクロール仕様
- 再計算仕様
- テスト方針（受け入れ条件）
- 実装制約

---

## 方針（実装アーキテクチャ）
- UI は **Monaco Editor を左右に2つ**配置して「VS Codeっぽい編集体験」を担保する
- 差分検出（行レベル/行内レベル）は **自前実装**し、結果を Monaco の **decoration（装飾）** で可視化する
- スクロール連動は本ツール側で制御し、**デフォルトON**／任意で **OFF（独立スクロール）** を提供する

> 目的は「VS Code の diff 表示と同様の挙動」を得ることだが、UI/スクロール制御の自由度を優先する。
> 将来的に必要になれば、差分検出ロジックだけを Monaco/VS Code 側の実装へ差し替え可能な設計にする。

---

## VS Code に近い使用感の方針

本ツールは「見た目」だけでなく **差分の出方（ペアリング/ハイライトの粒度/ブロックのまとまり方）** も VS Code の差分ビューに近い体験を目指す。

- 目的は **同じ入力に対して、ユーザーが違和感の少ない差分表示** を得ること
- 厳密に同一アルゴリズムであることは必須ではないが、挙動の優先順位は次の通りとする
  1. 変更ブロックのまとまり方（どこが1つの変更として見えるか）
  2. 行のペアリング（replace の作り方）
  3. 行内ハイライトの粒度（変更箇所が細かすぎ/粗すぎにならない）

---

## 用語

- **左ペイン / 右ペイン**: 比較対象の2つのテキスト表示領域
- **行**: `\n` で区切られた単位（CRLF は内部で LF へ正規化）
- **差分**: 2つのテキストの比較結果（行レベル + 行内レベル）
- **アンカー行**: 手動で「この行同士は対応」と固定するための基準点（後で実装）

---

## 1. ゴール（プロダクト要件）

### 1.1 できること（Must / MVP）

1. **2つのテキストを表示し、差分を行単位で可視化**できる  
2. 差分箇所は **行内（部分一致）もハイライト**できる（VS Code っぽく）  
3. **スクロール連動はデフォルト ON**  
4. ユーザー操作で **スクロール連動 OFF（独立スクロール）** に切り替えできる  
5. 手動で体裁を整えた後、**差分を再計算**できる  
6. **HTMLファイル単体で動く**（ビルド不要・オフラインOK）

### 1.2 できると嬉しい（Should / Later / 拡張）

- 変更の「前へ/次へ」ジャンプ
- アンカー行（手動で左右の対応付け）→ 再計算で反映
- 変更の折りたたみ、無視設定（空白/大文字小文字）
- ファイルのドラッグ&ドロップ機能

---

## 2. 非ゴール（最初はやらない）

- 巨大ファイル（数十万行）をスムーズに扱う最適化（後回し）
- 完全に VS Code のアルゴリズムと同一であること（“同じ思想”で十分）

---

## 3. UI仕様（MVP / 最小構成）

### 3.1 レイアウト

- 画面は左右2カラム
- 各カラムは上部にツールバー、下部に **Monaco Editor** を配置（左右で2つの通常エディタ）
- 中央に変更位置のミニマップ（後回しでも良い）

### 3.2 操作

- `スクロール連動: ON/OFF` トグル
- `差分再計算` ボタン
- `次の差分 / 前の差分` ボタン（MVPの最後に入れたい）

---

## 4. 差分仕様（MVPの核 / VS Code っぽさ）

### 4.1 正規化

- 入力テキストの改行は内部で `\n` に統一する
- 末尾改行の有無は「差分として扱う」（VS Code 挙動に寄せる）

### 4.2 行レベル差分

- 差分検出アルゴリズムは **Myers系（最短編集スクリプト）を基本**とし、VS Code/Monaco の一般的な差分挙動に近づける
- 将来的な差し替えに備え、差分検出は `diffEngine` として UI から分離し、入力（左右テキスト）→出力（差分モデル）を純粋関数で扱う

- 行配列にして比較し、以下の種類を返す
  - `equal`（同一行）
  - `insert`（右にだけ存在）
  - `delete`（左にだけ存在）
  - `replace`（左右で異なるが対応する行として並べる）

#### 4.2.1 replace の作り方（VS Code っぽさのための規則）

Myers の結果は基本的に `insert`/`delete` の列として得られるため、表示上の `replace` は次の規則で生成する。

- 連続する `delete` ブロックの直後に連続する `insert` ブロックが続く場合、それらを **1つの変更ブロック** とみなす
- 変更ブロック内で、`delete` と `insert` は **行のペアリング** を行い、ペアになった行を `replace` として扱う
- ペアリングは次の優先順位で決める
  1. **同じインデント（先頭の空白/タブの量が近い）** を優先
  2. 文字列の類似度（例: 文字単位の共通部分が多い）を優先
  3. それでも決まらない場合は、上から順に対応付け（安定性を優先）
- ペアにならなかった余りは `delete` または `insert` のまま残す

> 目的は「削除→追加」が並ぶケースを、ユーザーが自然に「置換」として読める形に寄せること。

- 表示は **左右で同じ縦位置に揃う**
  - 置換・挿入・削除でズレる部分は「表示上のスペーサー」で整列する
  - **エディタ本文（左右のテキスト）には空行を挿入しない**（表示専用の調整として扱う）
  - 実装は Monaco の viewZones 等の仕組みで高さ調整する想定（詳細は実装時に決める）

### 4.3 行内差分（部分ハイライト）

行内差分は `replace` 行にのみ適用し、左右両方に対して変更範囲を算出する。

※ range は「行内の 0-based 文字インデックス範囲（start は含む / end は含まない）」として扱う。

- ルール（MVP）
  - 基本は **文字単位** で差分を取り、左右それぞれの「変更された範囲（range）」を返す
  - 差分が極端に細かく分断されて視認性が落ちる場合は、隣接する小さな差分範囲を結合して表示して良い（視認性優先）
  - 空白のみの差分も MVP では差分として扱う（空白無視は拡張要件）
  - `diffEngine` の差分モデルを元に、**Monaco の decoration** でインライン強調表示する

---

## 5. スクロール仕様（最重要）

### 5.1 連動 ON 時

- 左をスクロールすると右も追従（逆も同様）
- **無限ループ防止**
  - 片方のスクロールイベントがもう片方を呼び続けない仕組みを必須とする

### 5.2 連動 OFF 時

- 左右は完全に独立してスクロール
- 差分ジャンプ（前/次）を実行した場合は、連動 OFF でも **左右両方を同じ差分ブロック先頭行** にスクロールして揃える

---

## 6. 再計算仕様

- テキストが編集されたら差分は古くなる（即時再計算は重いのでしない）
- `差分再計算` を押したタイミングで、現在の左右テキストから差分モデルを再生成して再描画する

---

## 7. テスト方針（仕様駆動の骨）
### 受け入れ条件（MVP）

- 同一テキスト同士を比較した場合、差分ブロックは 0 件で、行/行内ハイライトは付かない
- 右側に1行追加した場合、その行は `insert` として右側の行全体がハイライトされる（左側は表示上スペーサーで整列）
- 左側に1行だけ存在する行は `delete` として左側の行全体がハイライトされる（右側は表示上スペーサーで整列）
- `delete` ブロックの直後に `insert` ブロックがあるケースは、可能な限り `replace` としてペアリングされ、行内ハイライトが適用される
- スクロール連動 ON では左右が追従し、OFF では追従しない（無限ループしない）
- `差分再計算` を押すと、現在の左右テキストに基づいて差分表示が更新される

### 7.1 テスト階層

- **ユニットテスト**: 差分エンジン（入力→差分モデル）
- **ユニットテスト**: 行内差分（2文字列→ハイライト範囲）
- **DOMテスト**: トグル操作でスクロール連動が切り替わる
- **E2E は後回し**（まず Vitest + Testing Library で十分）

### 7.2 最初に書くべきテスト（MVPの最短ルート）

1. 行差分：同一、挿入、削除、置換の最低ケース  
2. スクロール連動：ON で追従する、OFF で追従しない  
3. 再計算：編集→ボタン→差分更新される  

---

## 8. 実装制約（プロジェクト要件）

- VS Code 上で開発
- CODEX エージェントで進める
- UI は Monaco Editor（左右に通常エディタ2つ）を採用する
- 差分検出は `diffEngine` として独立させ、差分モデルを Monaco decoration に変換して表示する
- スクロール連動はツール側で制御し、デフォルトON／任意でOFFを提供する
- 成果物は **単一HTMLでスタンドアロン動作**
  - 開発中は Vite/TypeScript/テスト導入 OK
  - 最終成果物として `dist/index.html` だけで動く形に落とす（ビルドでインライン化）

---

## 付録: diffEngine の差分モデル（案）

diffEngine は UI に依存しない純粋なデータを返す。
（Monaco への変換は別レイヤで行う）

### 行レベル

- `LineOp`
  - `type`: `equal | insert | delete`
  - `leftLine?: string` / `rightLine?: string`
  - `leftLineNo?: number` / `rightLineNo?: number`（元テキスト上の行番号）

- `PairedOp`
  - `type`: `equal | insert | delete | replace`
  - `leftLine?: string` / `rightLine?: string`
  - `leftLineNo?: number` / `rightLineNo?: number`

### 行内レベル（replace 行のみ）

- `Range`
  - `start: number`（含む）
  - `end: number`（含まない）

- `InlineDiff`
  - `leftRanges: Range[]`
  - `rightRanges: Range[]`
